{% extends "layout.html" %}

{% load quiz_extras %}  <!-- Load your template tags -->

{% block title %}
Custom Quiz: {{ question.text }}
{% endblock %}

{% block content %}
<h1 class="centered-title">Custom Quiz</h1>

<div class="quiz-container">
    <!-- Sidebar with Question Links -->
    <div class="question-sidebar">
        <h3>Questions</h3>
        <ul class="question-nav">
            {% for q in questions %}
                {% with status=question_statuses|get_item:q.id %}
                    {% if status == 'correct' %}
                        <li>
                            <a href="{% url 'custom_quiz_detail' q.id %}" class="question-link question-correct {% if q.id == question.id %}active{% endif %}">
                                Question {{ forloop.counter }}
                            </a>
                        </li>
                    {% elif status == 'incorrect' %}
                        <li>
                            <a href="{% url 'custom_quiz_detail' q.id %}" class="question-link question-incorrect {% if q.id == question.id %}active{% endif %}">
                                Question {{ forloop.counter }}
                            </a>
                        </li>
                    {% else %}
                        <li>
                            <a href="{% url 'custom_quiz_detail' q.id %}" class="question-link question-unanswered {% if q.id == question.id %}active{% endif %}">
                                Question {{ forloop.counter }}
                            </a>
                        </li>
                    {% endif %}
                {% endwith %}
            {% endfor %}
        </ul>
    </div>

    <!-- Main Question Area -->
    <div class="question-content">
        <div class="question-container">
            <h2>{{ question.text }}</h2>

            <!-- Link to Show the Image -->
            {% if question.images.all %}
                <a href="#image-container" class="show-image-link">Show Image</a>
            {% endif %}

            <!-- Options and Form -->
            <form method="post">
                {% csrf_token %}
                <div class="options">
                    {% for opt in option_list %}
                        <label class="option-label">
                            <input type="radio" name="selected_option" value="{{ opt }}"
                                   {% if selected_option == opt %}checked{% endif %}>
                            <span>{{ question|get_field:opt }}</span>
                        </label>
                    {% endfor %}
                </div>

                <!-- Button Logic -->
                {% if not answered %}
                    <!-- Check Answer Button -->
                    <button type="submit" name="action" value="check_answer" class="btn-check-answer">Check Answer</button>
                {% else %}
                    <!-- Show Next Question or Finish Quiz Buttons -->
                    {% if is_last_question %}
                        <button type="submit" name="action" value="finish_quiz" class="btn-finish-quiz">Finish Quiz</button>
                    {% else %}
                        <button type="submit" name="action" value="next_question" class="btn-next-question">Next Question</button>
                    {% endif %}
                {% endif %}
            </form>

            <!-- Explanation Section -->
            {% if answered %}
                <div class="explanation">
                    <p class="{% if is_correct %}correct-answer{% else %}incorrect-answer{% endif %}">
                        {{ is_correct|yesno:"Correct!,Incorrect." }}
                    </p>

                    {% if explanation_html %}
                        <p class="explanation-text">{{ explanation_html|safe }}</p>
                    {% endif %}

                    <!-- Show "Read More" Button -->
                    <a href="{% url 'detailed_explanation' question.question_id %}" target="_blank" class="btn-read-more">Read More</a>

                    <!-- Render Explanation Image if available -->
                    {% if question.explanation_image %}
                        <div class="explanation-image">
                            <img src="{{ question.explanation_image.url }}" alt="Explanation Image" class="standard-image">
                        </div>
                    {% endif %}
                </div>
            {% endif %}

            <!-- Image Section, Hidden by Default -->
            {% if question.images.all %}
                <div id="image-container" class="hidden-image-container">
                    {% for image in question.images.all %}
                        <img src="{{ image.image.url }}" alt="Question Image" class="standard-image">
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
